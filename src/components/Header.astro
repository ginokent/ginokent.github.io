---
import { type Locale, getAlternateLocaleUrl } from '../lib/i18n';

// ç¾åœ¨ã®ãƒ‘ã‚¹ã‹ã‚‰è¨€èªã‚’åˆ¤å®š
const currentPath = Astro.url.pathname;
const currentLang: Locale = currentPath.startsWith('/en') ? 'en' : 'ja';
const otherLang: Locale = currentLang === 'ja' ? 'en' : 'ja';

// ç¾åœ¨ã®è¨€èªã«å¿œã˜ãŸãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹
// æ—¥æœ¬èªã¯ prefix ãªã—ã€è‹±èªã¯ /en
const basePath = currentLang === 'en' ? '/en' : '';

// è¨€èªåˆ‡ã‚Šæ›¿ãˆå…ˆã® URL
const alternateLangUrl = getAlternateLocaleUrl(currentPath, otherLang);
---

<header class="header">
  <div class="container header-top">
    <a href={basePath || '/'} class="site-title">ginokent Blog</a>
    <div class="header-utils">
      <a href="/feed.xml" class="header-link" aria-label="RSS Feed">RSS</a>
      <a href={alternateLangUrl} class="header-link lang-switch" aria-label={`Switch to ${otherLang === 'en' ? 'English' : 'æ—¥æœ¬èª'}`}>
        {otherLang === 'en' ? 'EN' : 'JA'}
      </a>
      <button class="theme-toggle" id="theme-toggle" aria-label="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">
        <span class="theme-icon-light">â˜€ï¸</span>
        <span class="theme-icon-dark">ğŸŒ™</span>
      </button>
    </div>
  </div>
  <nav class="header-nav">
    <div class="container header-nav-inner">
      <a href={`${basePath}/about`} class="header-link">About</a>
      <a href={basePath || '/'} class="header-link">Posts</a>
      <a href="/scraps" class="header-link">Scraps</a>
    </div>
  </nav>
</header>

<style>
  .header-link {
    color: var(--text-secondary);
    font-size: 0.875rem;
    text-decoration: none;
    transition: color 0.2s;
  }

  .header-link:hover {
    color: var(--text);
  }

  .theme-icon-light,
  .theme-icon-dark {
    display: none;
  }

  /* Light mode: show moon (to switch to dark) */
  :global(:root:not([data-theme])) .theme-icon-dark,
  :global([data-theme='light']) .theme-icon-dark {
    display: inline;
  }

  /* Dark mode: show sun (to switch to light) */
  :global([data-theme='dark']) .theme-icon-light {
    display: inline;
  }

  /* System dark preference when no theme set */
  @media (prefers-color-scheme: dark) {
    :global(:root:not([data-theme])) .theme-icon-dark {
      display: none;
    }
    :global(:root:not([data-theme])) .theme-icon-light {
      display: inline;
    }
  }
</style>

<script>
  function initThemeToggle() {
    const toggle = document.getElementById('theme-toggle');
    if (!toggle) return;

    toggle.addEventListener('click', () => {
      const html = document.documentElement;
      const current = html.getAttribute('data-theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      let next: string;
      if (current === 'dark') {
        next = 'light';
      } else if (current === 'light') {
        next = 'dark';
      } else {
        // No explicit theme set, toggle based on system preference
        next = prefersDark ? 'light' : 'dark';
      }

      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });
  }

  initThemeToggle();
  document.addEventListener('astro:after-swap', initThemeToggle);
</script>
